<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BNI LINKED // DATABASE</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

  <div class="bg-grid"></div>

  <div class="app-container">
    
    <header class="top-bar">
      <div class="logo-area">
        <img src="../point/logo-bni-linked.png" alt="BNI Linked" class="app-logo">
        <div class="titles">
          <h1 class="main-title">SYSTEM DATABASE</h1>
          <span class="sub-title">ARCHIVES CLOUD S√âCURIS√âES</span>
        </div>
      </div>
      
      <nav class="main-nav">
        <a href="../point/" class="nav-btn">üï∏Ô∏è R√âTICULE</a>
        <a href="../map/" class="nav-btn">üó∫Ô∏è CARTE TACTIQUE</a>
      </nav>
    </header>

    <main class="content-panel">
      
      <div class="tabs-container">
        <button class="tab-btn active" data-tab="point">üìÇ BACKUPS R√âSEAU (POINT)</button>
        <button class="tab-btn" data-tab="map">üìÇ BACKUPS TACTIQUES (MAP)</button>
      </div>

      <div class="status-bar">
        <span class="status-indicator"></span>
        <span id="global-status">Syst√®me pr√™t. En attente de s√©lection...</span>
      </div>

      <div id="panel-point" class="panel active">
        <div class="panel-header-row">
          <h3>ARCHIVES R√âSEAU</h3>
          <div class="status-text" id="status-point">Chargement...</div>
        </div>
        <div class="cards-grid" id="cards-point"></div>
      </div>

      <div id="panel-map" class="panel">
        <div class="panel-header-row">
          <h3>ARCHIVES TACTIQUES</h3>
          <div class="status-text" id="status-map">Chargement...</div>
        </div>
        <div class="cards-grid" id="cards-map"></div>
      </div>

    </main>
  </div>

  <div id="custom-modal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header" id="modal-title">TITRE</div>
      <div class="modal-body" id="modal-text">Texte de la modale...</div>
      <div class="modal-footer" id="modal-footer">
        </div>
    </div>
  </div>

<script>
  // --- GESTION DES MODALES ---
  const modal = document.getElementById('custom-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalText = document.getElementById('modal-text');
  const modalFooter = document.getElementById('modal-footer');

  function showModal(title, text, type = 'alert') {
    return new Promise((resolve) => {
      modalTitle.textContent = title;
      modalText.textContent = text;
      modalFooter.innerHTML = '';

      if (type === 'confirm') {
        // Bouton Annuler
        const btnCancel = document.createElement('button');
        btnCancel.className = 'modal-btn';
        btnCancel.textContent = 'ANNULER';
        btnCancel.onclick = () => { closeModal(); resolve(false); };
        
        // Bouton Confirmer (Danger)
        const btnConfirm = document.createElement('button');
        btnConfirm.className = 'modal-btn danger';
        btnConfirm.textContent = 'CONFIRMER';
        btnConfirm.onclick = () => { closeModal(); resolve(true); };

        modalFooter.appendChild(btnCancel);
        modalFooter.appendChild(btnConfirm);
      } else {
        // Mode Alert (OK seulement)
        const btnOk = document.createElement('button');
        btnOk.className = 'modal-btn confirm';
        btnOk.textContent = 'OK';
        btnOk.onclick = () => { closeModal(); resolve(true); };
        modalFooter.appendChild(btnOk);
      }

      modal.classList.add('visible');
    });
  }

  function closeModal() {
    modal.classList.remove('visible');
  }

  async function customAlert(text) {
    await showModal('INFORMATION', text, 'alert');
  }

  async function customConfirm(text) {
    return await showModal('CONFIRMATION REQUISE', text, 'confirm');
  }


  // --- LOGIQUE JAVASCRIPT PRINCIPALE ---
  const tabs = document.querySelectorAll('.tab-btn');
  const panels = {
    point: document.getElementById('panel-point'),
    map: document.getElementById('panel-map')
  };
  const globalStatus = document.getElementById('global-status');

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      Object.values(panels).forEach(p => p.classList.remove('active'));
      panels[tab].classList.add('active');
      globalStatus.textContent = `Affichage des archives : ${tab.toUpperCase()}`;
    });
  });

  function fmtDate(iso) {
    if (!iso) return '‚Äî';
    try { return new Date(iso).toLocaleString('fr-FR'); } catch(e) { return iso; }
  }

  function makeFilename(entry) {
    const safeDate = (entry.createdAt || '').replace(/[:.]/g, '-');
    return `${entry.page}_${entry.action}_${safeDate || entry.ts}.json`;
  }

  // --- API CLIENT ---

  async function apiList(page) {
    const res = await fetch(`/.netlify/functions/db-list?page=${encodeURIComponent(page)}&limit=50`);
    if (!res.ok) throw new Error('Erreur r√©seau');
    const out = await res.json();
    if (!out.ok) throw new Error(out.error || 'Erreur API');
    return out; 
  }

  async function apiGet(key) {
    const res = await fetch(`/.netlify/functions/db-get?key=${encodeURIComponent(key)}`);
    if (!res.ok) throw new Error('Erreur r√©cup√©ration');
    return await res.json();
  }

  async function apiDelete(key) {
    const res = await fetch(`/.netlify/functions/db-delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key })
    });
    const out = await res.json().catch(()=>({ok:false}));
    if (!res.ok || !out.ok) throw new Error(out.error || 'Erreur suppression');
  }

  // --- RENDU ---

  function render(page, entries, totalFound) {
    const statusEl = document.getElementById(`status-${page}`);
    const cardsEl = document.getElementById(`cards-${page}`);
    cardsEl.innerHTML = '';

    if (!entries || !entries.length) {
      statusEl.textContent = 'Aucune donn√©e.';
      cardsEl.innerHTML = '<div class="empty-state">AUCUNE ARCHIVE TROUV√âE DANS LE CLOUD</div>';
      return;
    }

    const count = entries.length;
    const total = totalFound || count;
    
    if (total > count) {
        statusEl.textContent = `${count} R√âCENTS AFFICH√âS (SUR ${total} TOTAL)`;
    } else {
        statusEl.textContent = `${count} FICHIERS SYNCHRONIS√âS`;
    }

    for (const entry of entries) {
      const card = document.createElement('div');
      card.className = 'data-card';

      let actionType = 'UNK';
      let customName = '';

      if (entry.action.startsWith('import')) {
          actionType = 'üì• IMPORT';
          customName = entry.action.substring(7); 
      } else if (entry.action.startsWith('export')) {
          actionType = 'üíæ EXPORT';
          customName = entry.action.substring(7); 
      } else {
          actionType = entry.action.toUpperCase();
      }
      
      if (customName.startsWith('-')) customName = customName.substring(1);
      if (!customName) customName = "Standard";

      const badgeClass = entry.action.includes('import') ? 'badge-import' : 'badge-export';

      card.innerHTML = `
        <div class="card-top">
          <span class="badge ${badgeClass}">${actionType}</span>
          <span class="card-date">${fmtDate(entry.createdAt)}</span>
        </div>
        <div class="card-title">${customName.toUpperCase()}</div>
        <div class="card-key" style="opacity:0.3; font-size:0.7em;">ID: ${entry.ts}</div>
        <div class="card-actions">
          <button class="btn-cyber btn-dl">T√âL√âCHARGER</button>
          <button class="btn-cyber btn-del">SUPPRIMER</button>
        </div>
      `;

      const btnDl = card.querySelector('.btn-dl');
      const btnDel = card.querySelector('.btn-del');

      // T√âL√âCHARGER
      btnDl.addEventListener('click', async () => {
        btnDl.disabled = true;
        btnDl.textContent = '...';
        try {
          const data = await apiGet(entry.key);
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = makeFilename(entry);
          document.body.appendChild(a);
          a.click();
          URL.revokeObjectURL(a.href);
          a.remove();
          btnDl.textContent = 'OK';
        } catch (e) {
          await customAlert('Erreur lors du t√©l√©chargement du fichier.');
          btnDl.textContent = 'ERR';
        } finally {
          setTimeout(() => { btnDl.disabled = false; btnDl.textContent = 'T√âL√âCHARGER'; }, 2000);
        }
      });

      // SUPPRIMER (FIX AM√âLIOR√â)
      btnDel.addEventListener('click', async () => {
        // 1. Modale de confirmation
        const confirmed = await customConfirm('Voulez-vous vraiment supprimer d√©finitivement ce fichier du Cloud ?');
        if (!confirmed) return;

        btnDel.disabled = true;
        btnDel.textContent = '...';
        
        try {
          // 2. Appel API
          await apiDelete(entry.key);
          
          // 3. Suppression VISUELLE imm√©diate (Feedback instantan√©)
          // On fait dispara√Ætre la carte pour que l'utilisateur voit que √ßa a march√©
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';
          
          setTimeout(async () => {
             card.remove(); // On retire du DOM
             
             // 4. Attente de propagation (Le fix pour "√ßa supprime pas")
             // On attend 1 seconde pour que Netlify Blobs se mette √† jour avant de relire la liste
             await new Promise(r => setTimeout(r, 1000));
             await refreshPage(page);
          }, 300);

        } catch (e) {
          console.error(e);
          await customAlert('Erreur lors de la suppression. V√©rifiez votre connexion.');
          btnDel.textContent = 'ERR';
          btnDel.disabled = false;
        }
      });

      cardsEl.appendChild(card);
    }
  }

  async function refreshPage(page) {
    const statusEl = document.getElementById(`status-${page}`);
    statusEl.textContent = 'CONNEXION NEURAL LINK...';
    try {
      const data = await apiList(page);
      render(page, data.entries || [], data.totalFound);
    } catch (e) {
      statusEl.textContent = "ERREUR DE CONNEXION (DATA LINK)";
      console.warn("Erreur DB:", e);
      document.getElementById(`cards-${page}`).innerHTML = '<div class="error-state">CONNEXION SERVEUR √âCHOU√âE</div>';
    }
  }

  // Init
  refreshPage('point');
  refreshPage('map');
</script>
</body>
</html>